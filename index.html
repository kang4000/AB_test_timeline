<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>蜜蜂家校小程序端AB实验统一测算平台</title>
    <style>
        /* @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Roboto:wght@300;400;700&display=swap'); */
        /* Orbitron Regular (font-weight: 400) */
        @font-face {
        font-family: 'Orbitron';
        font-style: normal;
        font-weight: 400;
        src: local(''),
            url('./fonts/orbitron-v34-latin-regular.woff2') format('woff2'); /* */
        }

        /* Roboto Regular (font-weight: 400) */
        @font-face {
        font-family: 'Roboto';
        font-style: normal;
        font-weight: 400;
        src: local(''),
            url('./fonts/roboto-v48-latin-regular.woff2') format('woff2'); /* */
        }
        :root {
            --bg-color: #0f172a;
            --card-bg-color: #1e293b;
            --primary-color: #0ea5e9;
            --secondary-color: #64748b;
            --text-color: #e2e8f0;
            --title-color: #f8fafc;
            --accent-color: #10b981;
            --danger-color: #ef4444;
            --warning-color: #f59e0b;
            --border-color: #334155;
            --shadow-color: rgba(14, 165, 233, 0.5);
            --font-family-sans: 'Roboto', 'Helvetica Neue', Arial, sans-serif;
            --font-family-tech: 'Orbitron', sans-serif;
        }

        body {
            background-color: var(--bg-color);
            color: var(--text-color);
            font-family: var(--font-family-sans);
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 100vh;
            margin: 0;
            padding: 20px;
            box-sizing: border-box;
            font-size: 16px;
        }

        .container {
            width: 100%;
            max-width: 1400px;
            background: var(--card-bg-color);
            border-radius: 12px;
            border: 1px solid var(--border-color);
            box-shadow: 0 0 25px rgba(0, 0, 0, 0.4), 0 0 15px var(--shadow-color) inset;
            padding: 30px 40px;
            overflow: hidden;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            border-bottom: 2px solid var(--border-color);
            padding-bottom: 20px;
        }

        .header h1 {
            font-family: var(--font-family-tech);
            font-size: 2.2em;
            color: var(--title-color);
            letter-spacing: 2px;
            text-shadow: 0 0 5px var(--primary-color), 0 0 10px var(--primary-color);
            margin: 0;
        }

        .content-wrapper {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(420px, 1fr));
            gap: 40px;
        }
        
        .card {
            background: rgba(0,0,0,0.2);
            padding: 25px;
            border-radius: 8px;
            border: 1px solid var(--border-color);
        }

        .input-group {
            margin-bottom: 20px;
        }
        
        .input-group.hidden { display: none; }

        .input-group label, .fieldset-legend {
            display: block;
            margin-bottom: 12px;
            color: var(--primary-color);
            font-weight: bold;
            font-size: 0.9em;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .fieldset {
            border: 1px solid var(--border-color);
            border-radius: 6px;
            padding: 20px;
            padding-top: 30px;
            margin-bottom: 25px;
            position: relative;
        }

        .fieldset-legend {
            font-family: var(--font-family-tech);
            background: var(--card-bg-color);
            padding: 0 10px;
            margin-left: 10px;
            font-size: 1.1em;
            position: absolute;
            top: -14px;
        }
        
        summary::-webkit-details-marker,
        summary::marker {
            display: none;
        }

        .input-wrapper {
            display: flex;
            align-items: center;
            gap: 5px; /* Added gap for range inputs */
        }

        input[type="text"], input[type="number"], select {
            width: 100%;
            padding: 12px;
            background-color: var(--bg-color);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            color: var(--text-color);
            font-size: 1em;
            box-sizing: border-box;
            transition: border-color 0.3s, box-shadow 0.3s;
        }

        .input-wrapper .input-append {
            padding: 12px;
            background-color: #2c3a4f;
            border: 1px solid var(--border-color);
            border-left: none;
            border-radius: 0 6px 6px 0;
            white-space: nowrap;
            height: 48px; /* Match input height */
            box-sizing: border-box;
            display: flex;
            align-items: center;
        }

        .input-wrapper input + .input-append {
            border-left: 1px solid var(--border-color); /* Add border back for second input */
        }
        
        .input-wrapper input:first-child + .input-append {
            border-radius: 0;
            border-left: none;
        }


        input[type="text"]:focus, input[type="number"]:focus, select:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 8px var(--shadow-color);
        }

        .radio-group, .checkbox-group {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-top: 10px;
        }

        .radio-group label, .checkbox-group label {
            display: flex;
            align-items: center;
            background-color: var(--bg-color);
            padding: 10px 15px;
            border-radius: 6px;
            border: 1px solid var(--border-color);
            cursor: pointer;
            transition: all 0.3s ease;
            color: var(--text-color);
            font-weight: normal;
        }

        .radio-group input[type="radio"], .checkbox-group input[type="checkbox"] {
            display: none;
        }
        
        .checkbox-group input[type="checkbox"]:checked + label,
        .radio-group input[type="radio"]:checked + label {
            background-color: var(--primary-color);
            color: var(--bg-color);
            font-weight: bold;
            border-color: var(--primary-color);
            box-shadow: 0 0 10px var(--shadow-color);
        }
        
        .description {
            font-size: 0.85em;
            color: var(--secondary-color);
            margin-top: 8px;
            line-height: 1.5;
        }

        button {
            width: 100%;
            padding: 15px;
            background: linear-gradient(45deg, var(--primary-color), var(--accent-color));
            border: none;
            border-radius: 6px;
            color: var(--title-color);
            font-size: 1.2em;
            font-weight: bold;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.3s;
            margin-top: 20px;
            font-family: var(--font-family-tech);
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px var(--shadow-color);
        }
        
        .right-panel {
            display: flex;
            flex-direction: column;
            gap: 30px;
        }

        .output-card {
            display: none;
            background: radial-gradient(circle, rgba(14, 165, 233, 0.1) 0%, rgba(15, 23, 42, 0) 70%);
        }
        
        .output-card h2, .details-panel h3 {
            color: var(--accent-color);
            text-align: center;
            margin-top: 0;
            margin-bottom: 25px;
            font-family: var(--font-family-tech);
        }
        
        .output-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        .output-item {
            background-color: var(--bg-color);
            padding: 15px;
            border-radius: 6px;
            border-left: 4px solid var(--primary-color);
        }
        .output-item.full-width { grid-column: 1 / -1; }

        .output-item-label {
            font-size: 0.8em;
            color: var(--secondary-color);
            text-transform: uppercase;
            margin-bottom: 5px;
        }

        .output-item-value {
            font-size: 1.4em;
            font-weight: bold;
            color: var(--text-color);
        }
        
        .error-message {
            color: var(--danger-color);
            background-color: rgba(239, 68, 68, 0.1);
            border-left: 4px solid var(--danger-color);
            padding: 15px;
            border-radius: 6px;
            text-align: center;
            margin-top: 15px;
            font-weight: bold;
            display: none;
        }
        
        .details-panel { display: none; height: fit-content; }

        .table-container {
            max-height: 500px;
            overflow-y: auto;
            border-radius: 6px;
            border: 1px solid var(--border-color);
        }
        
        .table-container::-webkit-scrollbar { width: 8px; }
        .table-container::-webkit-scrollbar-track { background: var(--bg-color); border-radius: 4px; }
        .table-container::-webkit-scrollbar-thumb { background-color: var(--primary-color); border-radius: 4px; border: 2px solid var(--bg-color); }

        table { width: 100%; border-collapse: collapse; }

        thead th {
            position: sticky;
            top: 0;
            background-color: #1a2436;
            padding: 12px;
            text-align: left;
            color: var(--primary-color);
            font-size: 0.9em;
            font-weight: bold;
        }

        tbody td {
            padding: 10px 12px;
            border-top: 1px solid var(--border-color);
            font-size: 0.95em;
        }

        tbody tr:hover { background-color: rgba(14, 165, 233, 0.1); }
        
        td:last-child { font-weight: bold; color: var(--accent-color); text-align: right; }
        td:nth-child(2), td:nth-child(3) { text-align: right; }
        th:last-child, th:nth-child(2), th:nth-child(3) { text-align: right; }
        
        #result_insights {
            margin-top: 20px;
            padding: 15px;
            background: var(--bg-color);
            border-radius: 6px;
            line-height: 1.6;
        }
        #result_insights .result-warning { color: var(--warning-color); font-weight: bold; }
        
    </style>
</head>
<body>

    <div class="container">
        <div class="header">
            <h1>蜜蜂家校小程序端AB实验测算平台</h1>
            <h1>（仅新注册老师）</h1>
            <p style="font-size: 0.9em; color: var(--secondary-color); margin-top: 8px;">计算框架最后更新日期: 2025年9月12日 更新内容：补充渗透率考量</p>
            <p style="font-size: 0.9em; color: var(--secondary-color); margin-top: 8px;">数据源最后更新日期: 2025年10月9日 更新内容：将8月&9月的预测值替换为实际值</p>
        </div>

        <div class="content-wrapper">
            <div class="left-panel">
                <div class="card input-card">
                    
                    <div class="fieldset">
                        <div class="fieldset-legend">第零步: 实验设定（必填）</div>
                        <div class="input-group">
                            <label for="expName">实验名称</label>
                            <input type="text" id="expName" placeholder="例如：新版首页UI优化实验" >
                        </div>
                        <div class="input-group">
                           <label for="startDate">AB实验开始日期（after 20250801）</label>
                           <input type="date" id="startDate" value="2025-09-01" style="width: 100%;">
                        </div>
                    </div>

                    <div class="fieldset">
                        <div class="fieldset-legend">第一步: 定义框架</div>
                         <div class="input-group">
                            <label for="num_variations">1. 实验组数 (包含对照组)</label>
                            <input type="number" id="num_variations" value="2" min="2">
                        </div>
                        <div class="input-group">
                            <label for="metric_type">2. 核心指标类型</label>
                            <select id="metric_type">
                                <option value="proportion" selected>比例类 (如激活率, 点击率)</option>
                                <option value="mean">均值类 (如人均时长, 人均次数)</option>
                            </select>
                        </div>
                    </div>

                    <div class="fieldset">
                        <div class="fieldset-legend">第二步: 设定目标</div>
                        <div class="input-group">
                            <label for="exposure_rate_min">曝光率区间 (Min/Max)</label>
                            <div class="input-wrapper">
                                <input type="number" id="exposure_rate_min" value="20" min="1" max="100">
                                <span class="input-append">%</span>
                                <input type="number" id="exposure_rate_max" value="40" min="1" max="100">
                                <span class="input-append">%</span>
                            </div>
                            <p class="description">您的实验功能/策略，能触达到多少目标用户？</p>
                        </div>
                        <div class="input-group">
                            <label for="baseline_rate_min" id="baseline_label">3. 基线值区间 (筛选曝光后)</label>
                            <div class="input-wrapper">
                                <input type="number" id="baseline_rate_min" value="10">
                                <span id="baseline_unit_min" class="input-append">%</span>
                                <input type="number" id="baseline_rate_max" value="20">
                                <span id="baseline_unit_max" class="input-append">%</span>
                            </div>
                            <p class="description">【已被曝光】的用户群体，在核心指标上的当前数值范围。</p>
                        </div>
                        <div class="input-group">
                            <label for="mde">4. 最小可检测效应 (MDE)</label>
                            <div class="input-wrapper">
                                <input type="number" id="mde" value="20">
                                <span id="mde_unit" class="input-append">%</span>
                            </div>
                            <div class="radio-group" id="mde_type_group">
                                <input type="radio" id="mde_relative" name="mde_type" value="relative" checked> 
                                <label for="mde_relative">相对值%</label>
                                <input type="radio" id="mde_absolute" name="mde_type" value="absolute">
                                <label for="mde_absolute">绝对值</label>
                            </div>
                            <p class="description" id="mde_desc">您希望实验能检测出的最小变化幅度。</p>
                        </div>
                    </div>

                    <div class="fieldset">
                        <div class="fieldset-legend">第三步: 筛选流量</div>
                        <div class="input-group">
                            <label>观测学科 (多选，最终结果取周期较长者)</label>
                            <div class="checkbox-group">
                                <input type="checkbox" id="sub_all" name="subject" value="all"> <label for="sub_all">不区分</label>
                                <input type="checkbox" id="sub_chinese" name="subject" value="chinese" > <label for="sub_chinese">语文</label>
                                <input type="checkbox" id="sub_english" name="subject" value="english"checked> <label for="sub_english">英语</label>
                                <input type="checkbox" id="sub_math" name="subject" value="math"> <label for="sub_math">数学</label>
                            </div>
                             <p class="description">根据科目筛选，会影响每日可用样本量，从而影响实验周期。</p>
                        </div>
                    </div>
                    
                    <div class="fieldset">
                        <div class="fieldset-legend">第四步: 学段筛选</div>
                        <div class="input-group">
                            <label>是否只对小学灰度</label>
                            <div class="radio-group">
                                <input type="radio" id="is_primary_no" name="is_primary" value="no" checked>
                                <label for="is_primary_no">否</label>
                                <input type="radio" id="is_primary_yes" name="is_primary" value="yes">
                                <label for="is_primary_yes">是</label>
                            </div>
                            <p class="description">选择“是”将会根据小学用户占比(预估70%)，放大所需样本量。</p>
                        </div>
                    </div>
                    
                    <details class="fieldset">
                        <summary class="fieldset-legend" style="cursor: pointer;">第五步: 高级选项 (点击展开，默认不改动)</summary>
                        <div class="input-group">
                            <label for="power">统计功效 (Power, %)</label>
                            <input type="number" id="power" value="80" min="1" max="99.9">
                        </div>
                        <div class="input-group">
                            <label for="alpha">显著性水平 (Significance Level α, %)</label>
                            <input type="number" id="alpha" value="5" min="0.1" max="99">
                        </div>
                         <div class="input-group" id="conservative_mode_group">
                            <label>启用保守计算模式</label>
                             <div class="radio-group">
                                 <input type="radio" id="conservative_no" name="conservative" value="no">
                                 <label for="conservative_no">否</label>
                                 <input type="radio" id="conservative_yes" name="conservative" value="yes" checked>
                                 <label for="conservative_yes">是</label>
                             </div>
                            <p class="description" id="conservative_desc">
                                采用更严谨的校正方法或稳健方差估计，所需样本量会更高。
                            </p>
                        </div>
                    </details>
                    
                    <button id="calculateBtn">开始统一测算</button>
                    <div id="errorMessage" class="error-message"></div>
                </div>
            </div>

            <div class="right-panel">
                 <div class="card output-card" id="outputCard">
                    <h2>核心结论</h2>
                    <div class="output-grid">
                        <div class="output-item full-width">
                            <div class="output-item-label">实验名称</div>
                            <div class="output-item-value" id="outputExpName"></div>
                        </div>
                        <div class="output-item">
                            <div class="output-item-label">每组所需最小样本 (均值)</div>
                            <div class="output-item-value" id="outputSamplePerGroup"></div>
                        </div>
                        <div class="output-item">
                            <div class="output-item-label">实验所需总样本 (均值)</div>
                            <div class="output-item-value" id="outputTotalSample"></div>
                        </div>
                        <div class="output-item">
                            <div class="output-item-label">预计实验结束日期</div>
                            <div class="output-item-value" id="outputEndDate"></div>
                        </div>
                        <div class="output-item">
                            <div class="output-item-label">预估平均天数</div>
                            <div class="output-item-value" id="outputAvgDuration"></div>
                        </div>
                        <div class="output-item">
                            <div class="output-item-label">共需实验天数 (70%概率区间)</div>
                            <div class="output-item-value" id="outputDuration"></div>
                        </div>
                        <div class="output-item full-width">
                            <div class="output-item-label">建议检验方法</div>
                            <div class="output-item-value" id="outputTestMethod"></div>
                        </div>
                    </div>
                    <div id="result_insights"></div>
                </div>

                <div class="card details-panel" id="detailsPanel">
                    <h3>排期计算明细 (基于样本量均值)</h3>
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>日期</th>
                                    <th>当日新增</th>
                                    <th>累计样本</th>
                                    <th>累计进度</th>
                                </tr>
                            </thead>
                            <tbody id="detailsTableBody">
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const dailyData = {'2025-08-01': {'math': 75, 'chinese': 66, 'english': 116, 'other': 36, 'total': 293}, '2025-08-02': {'math': 107, 'chinese': 81, 'english': 63, 'other': 31, 'total': 282}, '2025-08-03': {'math': 101, 'chinese': 108, 'english': 89, 'other': 32, 'total': 330}, '2025-08-04': {'math': 90, 'chinese': 69, 'english': 100, 'other': 36, 'total': 295}, '2025-08-05': {'math': 65, 'chinese': 62, 'english': 73, 'other': 34, 'total': 234}, '2025-08-06': {'math': 73, 'chinese': 81, 'english': 86, 'other': 40, 'total': 280}, '2025-08-07': {'math': 97, 'chinese': 139, 'english': 104, 'other': 43, 'total': 383}, '2025-08-08': {'math': 64, 'chinese': 108, 'english': 114, 'other': 31, 'total': 317}, '2025-08-09': {'math': 35, 'chinese': 66, 'english': 61, 'other': 10, 'total': 172}, '2025-08-10': {'math': 31, 'chinese': 52, 'english': 58, 'other': 20, 'total': 161}, '2025-08-11': {'math': 49, 'chinese': 55, 'english': 81, 'other': 32, 'total': 217}, '2025-08-12': {'math': 40, 'chinese': 61, 'english': 63, 'other': 43, 'total': 207}, '2025-08-13': {'math': 47, 'chinese': 40, 'english': 49, 'other': 41, 'total': 177}, '2025-08-14': {'math': 54, 'chinese': 94, 'english': 76, 'other': 37, 'total': 261}, '2025-08-15': {'math': 53, 'chinese': 142, 'english': 66, 'other': 42, 'total': 303}, '2025-08-16': {'math': 33, 'chinese': 127, 'english': 64, 'other': 30, 'total': 254}, '2025-08-17': {'math': 58, 'chinese': 67, 'english': 102, 'other': 41, 'total': 268}, '2025-08-18': {'math': 46, 'chinese': 104, 'english': 147, 'other': 27, 'total': 324}, '2025-08-19': {'math': 109, 'chinese': 192, 'english': 90, 'other': 40, 'total': 431}, '2025-08-20': {'math': 267, 'chinese': 131, 'english': 86, 'other': 44, 'total': 528}, '2025-08-21': {'math': 191, 'chinese': 394, 'english': 174, 'other': 63, 'total': 822}, '2025-08-22': {'math': 107, 'chinese': 108, 'english': 96, 'other': 39, 'total': 350}, '2025-08-23': {'math': 96, 'chinese': 117, 'english': 190, 'other': 43, 'total': 446}, '2025-08-24': {'math': 113, 'chinese': 158, 'english': 146, 'other': 64, 'total': 481}, '2025-08-25': {'math': 193, 'chinese': 276, 'english': 244, 'other': 108, 'total': 821}, '2025-08-26': {'math': 255, 'chinese': 408, 'english': 291, 'other': 116, 'total': 1070}, '2025-08-27': {'math': 414, 'chinese': 624, 'english': 379, 'other': 288, 'total': 1705}, '2025-08-28': {'math': 285, 'chinese': 1011, 'english': 382, 'other': 168, 'total': 1846}, '2025-08-29': {'math': 548, 'chinese': 1142, 'english': 3007, 'other': 399, 'total': 5096}, '2025-08-30': {'math': 651, 'chinese': 920, 'english': 942, 'other': 305, 'total': 2818}, '2025-08-31': {'math': 631, 'chinese': 859, 'english': 891, 'other': 296, 'total': 2677}, '2025-09-01': {'math': 1705, 'chinese': 2698, 'english': 2671, 'other': 736, 'total': 7810}, '2025-09-02': {'math': 1192, 'chinese': 1821, 'english': 2105, 'other': 590, 'total': 5708}, '2025-09-03': {'math': 758, 'chinese': 1121, 'english': 1414, 'other': 357, 'total': 3650}, '2025-09-04': {'math': 1617, 'chinese': 3909, 'english': 2065, 'other': 1067, 'total': 8658}, '2025-09-05': {'math': 975, 'chinese': 1553, 'english': 1780, 'other': 579, 'total': 4887}, '2025-09-06': {'math': 683, 'chinese': 989, 'english': 1361, 'other': 434, 'total': 3467}, '2025-09-07': {'math': 577, 'chinese': 808, 'english': 1295, 'other': 343, 'total': 3023}, '2025-09-08': {'math': 668, 'chinese': 1306, 'english': 2042, 'other': 299, 'total': 4315}, '2025-09-09': {'math': 858, 'chinese': 2563, 'english': 1774, 'other': 319, 'total': 5514}, '2025-09-10': {'math': 556, 'chinese': 1388, 'english': 1384, 'other': 262, 'total': 3590}, '2025-09-11': {'math': 721, 'chinese': 1410, 'english': 1750, 'other': 350, 'total': 4231}, '2025-09-12': {'math': 813, 'chinese': 1542, 'english': 1712, 'other': 376, 'total': 4443}, '2025-09-13': {'math': 599, 'chinese': 922, 'english': 1636, 'other': 249, 'total': 3406}, '2025-09-14': {'math': 521, 'chinese': 767, 'english': 1078, 'other': 224, 'total': 2590}, '2025-09-15': {'math': 647, 'chinese': 1230, 'english': 1731, 'other': 262, 'total': 3870}, '2025-09-16': {'math': 706, 'chinese': 2201, 'english': 1614, 'other': 330, 'total': 4851}, '2025-09-17': {'math': 675, 'chinese': 1380, 'english': 2261, 'other': 342, 'total': 4658}, '2025-09-18': {'math': 519, 'chinese': 1439, 'english': 1655, 'other': 270, 'total': 3883}, '2025-09-19': {'math': 495, 'chinese': 1482, 'english': 1341, 'other': 235, 'total': 3553}, '2025-09-20': {'math': 360, 'chinese': 688, 'english': 1045, 'other': 187, 'total': 2280}, '2025-09-21': {'math': 904, 'chinese': 1590, 'english': 1222, 'other': 353, 'total': 4069}, '2025-09-22': {'math': 695, 'chinese': 1141, 'english': 3735, 'other': 278, 'total': 5849}, '2025-09-23': {'math': 815, 'chinese': 2709, 'english': 2002, 'other': 398, 'total': 5924}, '2025-09-24': {'math': 647, 'chinese': 1560, 'english': 1684, 'other': 420, 'total': 4311}, '2025-09-25': {'math': 527, 'chinese': 1438, 'english': 1692, 'other': 357, 'total': 4014}, '2025-09-26': {'math': 731, 'chinese': 1385, 'english': 1629, 'other': 467, 'total': 4212}, '2025-09-27': {'math': 345, 'chinese': 695, 'english': 938, 'other': 220, 'total': 2198}, '2025-09-28': {'math': 1091, 'chinese': 1281, 'english': 1452, 'other': 500, 'total': 4324}, '2025-09-29': {'math': 622, 'chinese': 2117, 'english': 1101, 'other': 589, 'total': 4429}, '2025-09-30': {'math': 622, 'chinese': 1342, 'english': 1157, 'other': 597, 'total': 3121}};

        // --- UIElement References ---
        const calculateBtn = document.getElementById('calculateBtn');
        const errorMessage = document.getElementById('errorMessage');
        const outputCard = document.getElementById('outputCard');
        const detailsPanel = document.getElementById('detailsPanel');
        const detailsTableBody = document.getElementById('detailsTableBody');

        // --- Statistical Helper Functions ---
        function inv_normal_cdf(p) {
            if (p <= 0 || p >= 1) return NaN;
            if (p < 0.5) return -inv_normal_cdf(1 - p);
            const a1=-39.69683028665376,a2=220.9460984245205,a3=-275.9285104469687,
                  a4=138.357751867269,a5=-30.66479806614716,a6=2.506628277459239;
            const b1=-54.47609879822406,b2=161.5858368580409,b3=-155.6989798598866,
                  b4=66.80131188771972,b5=-13.28068155288572;
            let q = p - 0.5; let r = q * q;
            let num = (((((a1*r+a2)*r+a3)*r+a4)*r+a5)*r+a6)*q;
            let den = (((((b1*r+b2)*r+b3)*r+b4)*r+b5)*r+1);
            return num / den;
        }

        function inv_t_cdf(p, df) {
            if (p <= 0 || p >= 1 || df <= 0) return NaN;
            const t = inv_normal_cdf(p);
            if (df === Infinity) return t;
            let g1 = (t**3 + t) / 4;
            let g2 = (5*t**5 + 16*t**3 + 3*t) / 96;
            let g3 = (3*t**7 + 19*t**5 + 17*t**3 - 15*t) / 384;
            let g4 = (79*t**9 + 776*t**7 + 1482*t**5 - 1920*t**3 - 945*t) / 92160;
            return t + (g1 / df) + (g2 / df**2) + (g3 / df**3) + (g4 / df**4);
        }
        
        function calculateYatesCorrectedSampleSize(z_alpha, z_beta, p1, p2, maxIterations = 100, tolerance = 0.1) {
            const effectSizeAbs = Math.abs(p2 - p1);
            const var1 = p1 * (1 - p1);
            const var2 = p2 * (1 - p2);
            let n = ((z_alpha * Math.sqrt(2 * ((var1 + var2) / 2))) + (z_beta * Math.sqrt(var1 + var2)))**2 / (effectSizeAbs**2);
            for (let i = 0; i < maxIterations; i++) {
                const yatesEffectSize = effectSizeAbs - 1 / (2 * n);
                if (yatesEffectSize <= 0) return n * 2;
                const newN = ((z_alpha * Math.sqrt(2 * ((var1 + var2) / 2))) + (z_beta * Math.sqrt(var1 + var2)))**2 / (yatesEffectSize**2);
                if (Math.abs(newN - n) < tolerance) return newN;
                n = newN;
            }
            return n;
        }
        
        function calculateWelchANOVASampleSize(z_alpha, z_beta, m1, m2, stdDev, stdDevRatio, numGroups) {
            const welchFactor = 1 + (stdDevRatio**2 - 1) / numGroups;
            const effectSize = Math.abs(m2 - m1);
            const n0 = 2 * (stdDev**2) * ((z_alpha + z_beta)**2) / (effectSize**2);
            return n0 * welchFactor;
        }
        
        function calculateSampleSize(params) {
            const { numVariations, power, alpha, metricType, isConservative, stdDevRatio, baselineRateValue, mdeValue, mdeType, stdDevValue } = params;

            const z_alpha_base = inv_normal_cdf(1 - alpha / 2);
            const z_beta = inv_normal_cdf(power);
            
            let samplePerGroup = 0;
            let testMethod = "";

            if (numVariations === 2) {
                if (metricType === 'proportion') {
                    testMethod = "双比例Z检验 (Z-test)";
                    const p1 = baselineRateValue;
                    const effectSizeAbs = mdeType === 'relative' ? p1 * mdeValue : mdeValue;
                    const p2 = p1 + effectSizeAbs;
                    if (p1 < 0 || p1 > 1 || p2 < 0 || p2 > 1 || effectSizeAbs === 0) return { error: "..." };
                    const var1 = p1 * (1 - p1); const var2 = p2 * (1 - p2);
                    if (isConservative) {
                        samplePerGroup = calculateYatesCorrectedSampleSize(z_alpha_base, z_beta, p1, p2);
                    } else {
                        samplePerGroup = ((z_alpha_base * Math.sqrt(2 * ((var1 + var2) / 2))) + (z_beta * Math.sqrt(var1 + var2)))**2 / (effectSizeAbs**2);
                    }
                } else { // Mean type
                    testMethod = "双样本t检验 (t-test)";
                    const stdDev = stdDevValue; const mde = mdeValue;
                    const n0 = 2 * (stdDev**2) * ((z_alpha_base + z_beta)**2) / (mde**2);
                    const df = 2 * n0 - 2;
                    const t_alpha = inv_t_cdf(1 - alpha / 2, df);
                    const t_beta = inv_t_cdf(power, df);
                    if (isConservative) {
                        samplePerGroup = 2 * (stdDev**2) * ((t_alpha + t_beta)**2) / (mde**2) * 1.15;
                    } else {
                        samplePerGroup = 2 * (stdDev**2) * ((t_alpha + t_beta)**2) / (mde**2);
                    }
                }
            } else { // ANOVA for multiple groups
                const numComparisons = numVariations - 1;
                const bonferroni_alpha = alpha / numComparisons;
                const z_alpha_corrected = inv_normal_cdf(1 - bonferroni_alpha / 2);
                if (metricType === 'proportion') {
                     const p1 = baselineRateValue;
                     const effectSizeAbs = mdeType === 'relative' ? p1 * mdeValue : mdeValue;
                     const p2 = p1 + effectSizeAbs;
                     if (p1 < 0 || p1 > 1 || p2 < 0 || p2 > 1 || effectSizeAbs === 0) return { error: "..." };
                     const varianceHomogeneity = Math.abs(p1 - p2) <= 0.15;
                     if (!varianceHomogeneity) { testMethod = "Welch ANOVA (方差不齐)"; } 
                     else { testMethod = "方差分析 (ANOVA) - 近似计算"; }
                     if (isConservative) {
                        const y1 = Math.asin(Math.sqrt(p1)); const y2 = Math.asin(Math.sqrt(p2));
                        const effectSizeTransformed = Math.abs(y2 - y1);
                        const stdDevTransformed = 0.5;
                        const n0_trans = 2 * (stdDevTransformed**2) * ((z_alpha_corrected + z_beta)**2) / (effectSizeTransformed**2);
                        const df_trans = 2 * n0_trans - 2;
                        const t_alpha_trans = inv_t_cdf(1 - bonferroni_alpha / 2, df_trans);
                        const t_beta_trans = inv_t_cdf(power, df_trans);
                        samplePerGroup = 2 * (stdDevTransformed**2) * ((t_alpha_trans + t_beta_trans)**2) / (effectSizeTransformed**2);
                     } else {
                        const var1 = p1 * (1 - p1); const var2 = p2 * (1 - p2);
                        if (!varianceHomogeneity) {
                            samplePerGroup = calculateWelchANOVASampleSize(z_alpha_corrected, z_beta, p1, p2, Math.sqrt(var1), stdDevRatio, numVariations);
                        } else {
                            samplePerGroup = ((z_alpha_corrected * Math.sqrt(2 * ((var1 + var2) / 2))) + (z_beta * Math.sqrt(var1 + var2)))**2 / (effectSizeAbs**2);
                        }
                     }
                } else { // Mean type
                     const stdDev = stdDevValue; const mde = mdeValue;
                     const n0 = 2 * (stdDev**2) * ((z_alpha_corrected + z_beta)**2) / (mde**2);
                     const df = 2 * n0 - 2;
                     const t_alpha_corrected = inv_t_cdf(1 - bonferroni_alpha / 2, df);
                     const t_beta = inv_t_cdf(power, df);
                     const varianceHomogeneity = stdDevRatio <= 1.5;
                     if (!varianceHomogeneity) {
                        testMethod = "Welch ANOVA (方差不齐)";
                        samplePerGroup = calculateWelchANOVASampleSize(z_alpha_corrected, z_beta, 0, mde, stdDev, stdDevRatio, numVariations);
                     } else {
                        testMethod = "方差分析 (ANOVA) - 近似计算";
                        if (isConservative) {
                            samplePerGroup = 2 * (stdDev**2) * ((t_alpha_corrected + t_beta)**2) / (mde**2) * 1.2;
                        } else {
                            samplePerGroup = 2 * (stdDev**2) * ((t_alpha_corrected + t_beta)**2) / (mde**2);
                        }
                     }
                }
            }
            samplePerGroup = Math.ceil(samplePerGroup);
            const totalSample = samplePerGroup * numVariations;
            return { samplePerGroup, totalSample, testMethod };
        }

        function calculateScheduleForTarget(targetSample, config) {
            const { exposureRateValue, selectedSubjects, startDateStr } = config;
            const startDate = new Date(startDateStr);
            let resultsBySubject = [];
            let allCalcsPossible = true;

            for (const subject of selectedSubjects) {
                let accumulatedUsers = 0;
                let days = 0;
                let currentDate = new Date(startDate);
                let endDate = null;
                let dailyBreakdown = [];

                while (accumulatedUsers < targetSample) {
                    const dateKey = currentDate.toISOString().split('T')[0];
                    const dayData = dailyData[dateKey];
                    if (!dayData) { endDate = null; break; }

                    let dailyIncrease = 0;
                    switch (subject) {
                        case 'all': dailyIncrease = dayData.total; break;
                        case 'chinese': dailyIncrease = dayData.chinese; break;
                        case 'english': dailyIncrease = dayData.english; break;
                        case 'math': dailyIncrease = dayData.math; break;
                    }
                    
                    accumulatedUsers += dailyIncrease * (exposureRateValue / 100);
                    days++;

                    dailyBreakdown.push({
                        date: dateKey,
                        increase: dailyIncrease * (exposureRateValue / 100),
                        cumulative: accumulatedUsers,
                        progress: (accumulatedUsers / targetSample * 100)
                    });
                    
                    if (accumulatedUsers >= targetSample) {
                        endDate = new Date(currentDate);
                        break;
                    }
                    currentDate.setDate(currentDate.getDate() + 1);
                }
                
                if (endDate) {
                    resultsBySubject.push({ subject, days, endDate, dailyBreakdown });
                } else {
                    allCalcsPossible = false;
                }
            }
            
            if (resultsBySubject.length > 0 && allCalcsPossible) {
                return resultsBySubject.reduce((max, current) => (current.days > max.days) ? current : max, resultsBySubject[0]);
            } else {
                return { error: `无法为学科 ${selectedSubjects.join(', ')} 攒够样本` };
            }
        }
        
        function runSingleCalculation(config) {
            const { baselineRateValue, ...staticConfig } = config;
            
            const mdeType = document.querySelector('input[name="mde_type"]:checked').value;
            const sampleSizeParams = {
                ...staticConfig,
                baselineRateValue: staticConfig.metricType === 'proportion' ? baselineRateValue / 100 : baselineRateValue,
                mdeValue: staticConfig.metricType === 'proportion' ? staticConfig.mdeValue / 100 : staticConfig.mdeValue,
                mdeType
            };
            const sampleSizeResult = calculateSampleSize(sampleSizeParams);
            if (sampleSizeResult.error || !isFinite(sampleSizeResult.totalSample) || sampleSizeResult.totalSample <= 0) {
                return { error: "无法计算样本量" };
            }
            
            let { totalSample, testMethod } = sampleSizeResult;

            let sampleAfterPrimaryFilter = totalSample;
            if (staticConfig.isPrimaryOnly) {
                sampleAfterPrimaryFilter = Math.ceil(totalSample / 0.70);
            }
            const finalSample = sampleAfterPrimaryFilter;

            const scheduleResult = calculateScheduleForTarget(finalSample, config);
            if(scheduleResult.error) return { error: scheduleResult.error };

            return { ...scheduleResult, finalSample, testMethod };
        }

        calculateBtn.addEventListener('click', () => {
            errorMessage.style.display = 'none';
            outputCard.style.display = 'none';
            detailsPanel.style.display = 'none';
            detailsTableBody.innerHTML = '';
            
            const getNumericInput = (id) => parseFloat(document.getElementById(id).value);
            
            const expName = document.getElementById('expName').value;
            const startDateStr = document.getElementById('startDate').value;
            if (!expName || !startDateStr) {
                errorMessage.textContent = '错误：实验名称和开始日期为必填项。';
                errorMessage.style.display = 'block';
                return;
            }

            const baselineMin = getNumericInput('baseline_rate_min');
            const baselineMax = getNumericInput('baseline_rate_max');
            const exposureMin = getNumericInput('exposure_rate_min');
            const exposureMax = getNumericInput('exposure_rate_max');

            if (isNaN(baselineMin) || isNaN(baselineMax) || isNaN(exposureMin) || isNaN(exposureMax) || baselineMin > baselineMax || exposureMin > exposureMax) {
                errorMessage.textContent = '错误：请输入有效的基线值和曝光率区间 (最小值需小于等于最大值)。';
                errorMessage.style.display = 'block';
                return;
            }

            const staticConfig = {
                numVariations: getNumericInput('num_variations'),
                power: getNumericInput('power') / 100,
                alpha: getNumericInput('alpha') / 100,
                metricType: document.getElementById('metric_type').value,
                isConservative: document.querySelector('input[name="conservative"]:checked').value === 'yes',
                stdDevRatio: 1, // 固定为理想值1
                stdDevValue: (baselineMin + baselineMax) / 2, // 根据基线均值估算
                mdeValue: getNumericInput('mde'),
                isPrimaryOnly: document.querySelector('input[name="is_primary"]:checked').value === 'yes',
                selectedSubjects: Array.from(document.querySelectorAll('input[name="subject"]:checked')).map(cb => cb.value),
                startDateStr: startDateStr
            };
            
            if (staticConfig.selectedSubjects.length === 0) {
                 errorMessage.textContent = '错误：请至少选择一个观测学科。';
                 errorMessage.style.display = 'block';
                 return;
            }

            // --- Run Monte Carlo Simulation ---
            const simulations = 10000;
            let simulationResults = []; // Store {days, finalSample}

            for (let i = 0; i < simulations; i++) {
                const randomBaseline = baselineMin + Math.random() * (baselineMax - baselineMin);
                const randomExposure = exposureMin + Math.random() * (exposureMax - exposureMin);
                const singleRunResult = runSingleCalculation({
                    ...staticConfig,
                    baselineRateValue: randomBaseline,
                    exposureRateValue: randomExposure
                });

                if (!singleRunResult.error) {
                    simulationResults.push({ 
                        days: singleRunResult.days, 
                        finalSample: singleRunResult.finalSample,
                        testMethod: singleRunResult.testMethod
                    });
                }
            }

            if (simulationResults.length < simulations * 0.5) {
                errorMessage.innerHTML = `计算失败：在超过50%的模拟场景下，无法在 2025-09-30 前攒够所需样本量。<br>请检查输入范围，特别是基线值和MDE是否过低。`;
                errorMessage.style.display = 'block';
                return;
            }

            // --- Analyze simulation results ---
            simulationResults.sort((a, b) => a.days - b.days);

            // 1. 定义70%概率区间 (截去头部20%和尾部10%)
            const lowerBoundIndex = Math.floor(simulationResults.length * 0.20);
            const upperBoundIndex = Math.floor(simulationResults.length * 0.90);
            const minDays = simulationResults[lowerBoundIndex].days;
            const maxDays = simulationResults[upperBoundIndex].days;
            const testMethod = simulationResults[0].testMethod; // Test method is consistent across runs

            // 2. 在此70%区间内，计算样本量的均值
            const filteredResults = simulationResults.slice(lowerBoundIndex, upperBoundIndex + 1);
            const sumOfSamples = filteredResults.reduce((total, current) => total + current.finalSample, 0);
            const avgFilteredSample = Math.round(sumOfSamples / filteredResults.length);

            // 3. 基于样本量均值，反推平均天数和逐日明细
            const avgConfig = {
                ...staticConfig,
                exposureRateValue: (exposureMin + exposureMax) / 2
            };
            const avgRunResult = calculateScheduleForTarget(avgFilteredSample, avgConfig);
            
            if(avgRunResult.error){
                 errorMessage.innerHTML = `无法生成代表性排期，请检查输入。`;
                 errorMessage.style.display = 'block';
                 return;
            }
            const avgDays = avgRunResult.days;
            
            // --- Display results ---
            const startDate = new Date(startDateStr);
            const minEndDate = new Date(startDate);
            minEndDate.setDate(startDate.getDate() + minDays - 1);
            const maxEndDate = new Date(startDate);
            maxEndDate.setDate(startDate.getDate() + maxDays - 1);
            
            document.getElementById('outputExpName').textContent = expName;
            document.getElementById('outputSamplePerGroup').textContent = Math.round(avgFilteredSample / staticConfig.numVariations).toLocaleString();
            document.getElementById('outputTotalSample').textContent = avgFilteredSample.toLocaleString();
            document.getElementById('outputEndDate').textContent = `${minEndDate.toLocaleDateString('zh-CN')} ~ ${maxEndDate.toLocaleDateString('zh-CN')}`;
            document.getElementById('outputAvgDuration').textContent = `${avgDays} 天`;
            document.getElementById('outputDuration').textContent = `${minDays} ~ ${maxDays} 天`;
            document.getElementById('outputTestMethod').textContent = testMethod;

            let insights = [];
            insights.push(`<b>区间预测说明</b>: 基于10000次模拟，实验所需总样本量的均值为 <b>${avgFilteredSample.toLocaleString()}</b> (在70%概率区间内计算)，由此推算预估平均耗时为 <b>${avgDays} 天</b>。`);
            insights.push(`排除掉20%的过快情况和10%的过慢情况后，实验周期有70%的概率落在 <b>${minDays} ~ ${maxDays} 天</b> 之间。`);

            if (maxDays > 60) {
                 insights.push(`<span class="result-warning">周期过长警告：预估周期上限超过60天风险极高，强烈建议调整实验设计（如放宽MDE或扩大流量）。</span>`);
            } else {
                 insights.push('实验时长在合理范围内，可按此规划排期。');
            }
            if (staticConfig.isPrimaryOnly) {
                insights.push(`<b>小学灰度说明</b>: 已根据小学用户占比(70%)修正所需总样本量。`);
            }
            
            document.getElementById('result_insights').innerHTML = insights.join('<hr style="border-color: var(--border-color); margin: 10px 0;">');
            outputCard.style.display = 'block';

            avgRunResult.dailyBreakdown.forEach(day => {
                const row = document.createElement('tr');
                const progressPercent = Math.min(day.progress, 100).toFixed(2);
                row.innerHTML = `
                    <td>${day.date}</td>
                    <td>${Math.round(day.increase).toLocaleString()}</td>
                    <td>${Math.round(day.cumulative).toLocaleString()}</td>
                    <td>${progressPercent}%</td>
                `;
                detailsTableBody.appendChild(row);
            });
            detailsPanel.style.display = 'block';
        });

        // --- UI Update Handlers ---
        function setupEventListeners() {
            const allInputs = document.querySelectorAll('input, select');
            allInputs.forEach(input => {
                input.addEventListener('change', handleUiChanges);
            });
        }
        
        function handleUiChanges() {
            const metricType = document.getElementById('metric_type').value;
            const isProportion = metricType === 'proportion';
            
            document.getElementById('mde_type_group').classList.toggle('hidden', !isProportion);
            
            const baselineLabel = document.getElementById('baseline_label');
            const baselineUnitMin = document.getElementById('baseline_unit_min');
            const baselineUnitMax = document.getElementById('baseline_unit_max');
            const mdeUnit = document.getElementById('mde_unit');
            const mdeTypeRadios = document.querySelectorAll('input[name="mde_type"]');

            if (isProportion) {
                baselineLabel.textContent = "3. 基线值区间 (筛选曝光后)";
                baselineUnitMin.textContent = "%";
                baselineUnitMax.textContent = "%";
                mdeUnit.textContent = "%";
                document.getElementById('mde_absolute').nextElementSibling.textContent = '绝对值%';
                mdeTypeRadios.forEach(r => r.disabled = false);
            } else {
                baselineLabel.textContent = "3. 基线值区间 (如: 人均时长)";
                baselineUnitMin.textContent = "值";
                baselineUnitMax.textContent = "值";
                mdeUnit.textContent = "值";
                document.getElementById('mde_absolute').checked = true;
                document.getElementById('mde_absolute').nextElementSibling.textContent = '绝对值';
                mdeTypeRadios.forEach(r => r.disabled = true);
            }
        }
        
        document.addEventListener('DOMContentLoaded', function() {
            setupEventListeners();
            handleUiChanges();
        });

    </script>
</body>
</html>